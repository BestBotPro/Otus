# Upstream для Django-приложения
upstream django {
	server app:8000;
}

# Конфигурация сервера для локального Node.js приложения на порту 8082
server {
	listen 8082;
	listen [::]:8082;
	server_name localhost;

	location / {
		proxy_pass http://node:3000; # перенаправление запросов на Node.js приложение
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
	}
}

# Конфигурация сервера для WordPress на порту 8083
server {
	listen 8083;
	listen [::]:8083;
	server_name example.com www.example.com;
	root /var/www/html;
	index index.php index.html index.htm;

	# Специальные правила для файлов верификации ACME (Let's Encrypt)
	location ~ /.well-known/acme-challenge {
		allow all;
		root /var/www/html;
	}

	# Обработка статических файлов с максимальным сроком кеширования
	location ~* \.(css|gif|ico|jpeg|jpg|js|png)$ {
		expires max;
		log_not_found off;
	}

	# Запрет доступа к файлам .ht
	location ~ /\.ht {
		deny all;
	}

	# Стандартные настройки для файлов favicon и robots.txt
	location = /favicon.ico {
		log_not_found off; access_log off;
	}
	location = /robots.txt {
		log_not_found off; access_log off; allow all;
	}

	# Обработка PHP-файлов через FastCGI
	location ~ \.php$ {
		try_files $uri =404;
		fastcgi_split_path_info ^(.+\.php)(/.+)$;
		fastcgi_pass wordpress:9000;
		fastcgi_index index.php;
		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
		fastcgi_param PATH_INFO $fastcgi_path_info;
	}
}

# Конфигурация сервера для локального Django приложения на порту 8081
server {
	listen 8081;
	listen [::]:8081;
	server_name localhost;

	location / {
		try_files $uri @proxy_to_app; # попытка найти файл, если не найден - перенаправление
	}

	location @proxy_to_app {
		proxy_pass http://django; # перенаправление запросов на Django upstream
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";
		proxy_redirect off;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Host $server_name;
	}
}
